<h1>Check out the JS console in your browser</h1>

<div id="main-content">
  <p>Visit http://localhost:1337?usernameHere to fetch location and arrive in your current zone.</p>

  <h5>For example:</h5>
  <ul>
    <li><a href="http://localhost:1337?rachaelshaw">http://localhost:1337?rachaelshaw</a></li>
    <li><a href="http://localhost:1337?irlnathan">http://localhost:1337?irlnathan</a></li>
    <li><a href="http://localhost:1337?particlebanana">http://localhost:1337?particlebanana</a></li>
    <li><a href="http://localhost:1337?sgress454">http://localhost:1337?sgress454</a></li>
    <li><a href="http://localhost:1337?mikermcneil">http://localhost:1337?mikermcneil</a></li>
  </ul>
</div>

<div id="map"></div>

<div id="activity-log"></div>

<script>

// Come up with a username
var username = window.location.search.replace(/^\?/, '');

// If no username was specified, stop here.
if (!username) {
  throw new Error('No username specified.  Try again w/ a username to continue.')
}

// Get location from browser
if (!navigator.geolocation){
  throw new Error('Geolocation is not supported by your browser.');
}

var $mainContent = document.getElementById('main-content');
console.log('getting location from browser...');
$mainContent.innerHTML = '<p>Getting location from browser...</p>';
navigator.geolocation.getCurrentPosition(function gotLocation(geoPosition){
  console.log('• got it!', geoPosition);

  // Display map
  var $map = document.getElementById('map');
  var mapImg = new Image();
  mapImg.src = 'https://maps.googleapis.com/maps/api/staticmap?center=' + geoPosition.coords.latitude + ',' + geoPosition.coords.longitude + '&zoom=13&size=300x300&sensor=false';
  $map.appendChild(mapImg);

  // Communicate w/ server
  console.log('communicating with server...');
  $mainContent.innerHTML = '<p>Communicating with server...</p>';
  io.socket.put('/user/'+username+'/zone', {
    lat: geoPosition.coords.latitude,
    long: geoPosition.coords.longitude
  }, function(data, jwr){
    if (jwr.error) {
      console.error('Server responded with an error.  (Please refresh the page and try again.)');
      console.error('Error details:');
      console.error(jwr.error);
      return;
    }//-•

    $mainContent.innerHTML = '<p>Welcome, '+username+'!</p>';
    console.log('It worked!  Now arrived in zone.');
    console.log('You can change your remark by running the following code:');
    console.log('```');
    console.log('io.socket.put(\'/user/'+username+'/remark\',{remark: \'hi\'},console.log.bind(console))');
    console.log('```');


    io.socket.on('zone', function(msg){
      console.log('* * Received zone notification from server with message:', msg);
      var $activityLog = document.getElementById('activity-log');
      $activityLog.append((new Date())+' :: Received zone notification from server:');
      $activityLog.appendChild(document.createElement('br'));
      $activityLog.append(JSON.stringify(msg));
      $activityLog.appendChild(document.createElement('br'));
      $activityLog.appendChild(document.createElement('br'));
    });

  });
}, function failedToGetLocation(err) {
  $mainContent.innerHTML = '<p>Failed to get location (see JS console for details)</p>';
  console.error('Could not load location.  (Please refresh the page and try again.)');
  console.error('Error details:');
  console.error(err);
})


</script>
